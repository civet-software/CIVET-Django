<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
    <title>{{page_title}}</title>
	<meta name="generator" content="BBEdit 11.0" />
<style> {# 15.08.31: This is currently fine tuned to produce a nice screen for the manual; the settings may or may generalize. #}
    body {
        height:700px;
        width:960px;
        padding:5px; 
        border: 2px dashed blue     
        }
    h1 { 
        font-size: 2em;
        margin-top: 0;
        margin-bottom: 0.67em;
        margin-left: 0;
        margin-right: 0;
        font-weight: bold;
        }
    h2 { 
        font-size: 1.5em;
        margin-top: 0;
        margin-bottom: 0.67em;
        margin-left: 0;
        margin-right: 0;
        font-weight: bold;
        }
    h3 { 
        font-size: 1.2em;
        margin-top: 0em;
        margin-bottom: 0.67em;
        margin-left: 0;
        margin-right: 0;
        font-weight: bold;
        }    
    .highlight {background-color:lightgreen;}
    .termst {color:red;}
    .civ-text-display {
        float:left; 
        line-height:1.5em;
        padding:5px;
        border:4px double #DEBB07;
        overflow:auto;    
        }
    .civ-text-display-size {  {# using two classes here allows the size to be reset while effectively inheriting the other styles #}
        width:48%;
        height:80%;  {# allows for header; otherwise 90% #}
        }
    .civ-form {
        float:right; 
        width:48%;
        height:90%;
        line-height:1.5em;
        padding:5px;
        }
    .civ-form-size {
        width:48%;
        height:70%;
        }
    .textlede{
        color:green; 
        font-weight:bold;    
        padding-top: 8px;
    }
    .textcontent{
        font-size:0.8em;    
    }
    .docbutton{
            background-color: transparent;
            border: solid, 1px;
            width: 120px    
    }
    .pagebutton {
      padding:5px;
      width: 50px;
      border: 2px solid #666;
      background: transparent;
    }    
    {{ newterm }}
    {{ form_css }}

</style>
</head>
<!--
General comment <pas, 15.07.10 >
This is the first code I wrote for CIVET and at the time -- well, still -- I was really just getting going on Javascript and
the DOM approach, and there are probably a number of ways that this could be improved. If the code looks awkward, that's
because it is.

<15.08.23>: Using simple javascript rather than jQuery is a feature, not a bug: jQuery has overhead and at this point
javascript seems quite adequate. 
-->
<body onload="initglobals()">
<script>

// declare an assortment of globals
// If a point is reached where jQuery is used, the constants here could be replaced by the jQuery 'event.which' 
var MOVE_LEFT = 37
var MOVE_RIGHT = 39
var MOVE_UP = 38
var MOVE_DOWN = 40

var	wdindex = 0  // location of start of search for next word in wordset
var extracting = false  // true when a field associated with a category is in focus
var	curstr = ""   // text of current highlighted word
var curcategory = ""  // category associated with the field currently in focus
var curfield = ""  // field currently in focus
var inputText  // document.getElementById("inputText")
var glinner    // inputText without any highlighting
var lastkey = MOVE_RIGHT  // used to identify direction reversals

function initglobals()
{
	inputText = document.getElementById("inputText")
	glinner = inputText.innerHTML 
    document.onkeydown =  dokeydown
    {% autoescape off %}
        {{ listeners }}
    {% endautoescape %}
}


function nexthightag(thekey)
// highlight the next/previous term in the class; called with either MOVE_RIGHT or MOVE_LEFT
{
    var curHTML = glinner  //
    if (curHTML.indexOf(curcategory) < 0) { return }  // this class is not in the text so do nothing
    if (lastkey != thekey) {  // handle reversal of direction
// <pas 15.07.24: there's still a minor bug in this that occasionally requires hitting the key twice: not a sufficient big deal to correct right now   
        if (lastkey == MOVE_RIGHT) {wdindex = curHTML.lastIndexOf('<span ',wdindex) - 1}
        if (lastkey == MOVE_LEFT) {wdindex = curHTML.indexOf('</span>',wdindex) + 1}
        lastkey = thekey
    }       
    if (thekey == MOVE_RIGHT) {
        wdindex = curHTML.indexOf(curcategory,wdindex)
        if (wdindex < 0)  { wdindex = curHTML.indexOf(curcategory)} // wraps back to beginning
    } else {
        wdindex = curHTML.lastIndexOf(curcategory,wdindex)
        if (wdindex < 0) { wdindex = curHTML.lastIndexOf(curcategory)} // wrap to end
    }

    var endspace = curHTML.indexOf("</span>",wdindex+1) + 7
    var startspace = curHTML.lastIndexOf("<span ",wdindex)
    var startcontent = curHTML.indexOf(">",wdindex)+1
//	console.log("Indices: " + wdindex + '  ' + endspace )   
//	console.log("String 1: " + curHTML.substring(0,wdindex-1))   
//	console.log("String 2: " + curHTML.substring(wdindex-13,endspace))   
    curstr = curHTML.substring(startcontent,endspace-7) // global which has the current highlighted content
    curHTML = curHTML.substring(0,startspace) + "<span class='highlight'>" + curHTML.substring(startspace,endspace) + "</span>" + curHTML.substring(endspace)
//	console.log("curHTML: " + curHTML)   
    inputText.innerHTML = curHTML
    if (thekey == MOVE_RIGHT) {
        wdindex = endspace + 1
        if (wdindex >= glinner.length) { wdindex = 0}  // should that be curHTML?
    } else {
        wdindex -= 1
        if (wdindex >= glinner.length) { wdindex = 0}  // should that be curHTML?
    }
    var list = document.getElementsByClassName(curcategory)  // change color of the words in the active category
    for (var i = 0; i < list.length; i++) {
        list[i].style.color="red"
    }
}

function coloraclass(category, thisfield)
// initialization for a new category
{
	curfield = thisfield  // text entry field which we are trying to fill
    curcategory = category
    wdindex = 0
    lastkey = MOVE_RIGHT
    nexthightag(MOVE_RIGHT)  // this actually does the coloring
    extracting = true
    document.getElementById("inputText").focus()
}

function cancelclass()
// deactivates the category extraction; called `onblur'
{
    document.getElementById("inputText").blur()
    inputText.innerHTML = glinner
    extracting = false
}

function dokeydown(evt)
// handles the arrow keys when extracting==true
{
    if (!extracting) {return}  
    var charCode = evt.keyCode
//    console.log('Down '+charCode )
    if (charCode == MOVE_RIGHT || charCode == MOVE_LEFT) {
        nexthightag(charCode)  // go to the next/previous term in the class
    } else if (charCode == MOVE_DOWN) {  // set the field to the highlighted text
    	var elem = document.getElementById(curfield)
        if (document.getSelection().toString().length > 0) {
            elem.value = document.getSelection().toString()
        } else {
            elem.value = curstr
        }
    } else if (charCode == MOVE_UP) {  // add the highlighted text to the current contents of the field
    	var elem = document.getElementById(curfield)
        if (document.getSelection().toString().length > 0) {
            elem.value = elem.value + ' ' + document.getSelection().toString()
        } else {
            elem.value = elem.value + ' ' + curstr
        }
    }
}

function togglecontent(event,divid) 
// toggles display of the content of divid; deletes text on shift-click and adds the textid to deletelist 
{ 
//    console.log('toggle call '+divid )
    if (event.shiftKey) {
        var myDiv = document.getElementById(divid);
        myDiv.style.display = 'none'
        myDiv = document.getElementById('ld'.concat(divid));
        myDiv.style.display = 'none'
        console.log('textid '+ myDiv.getAttribute("textid") )
        document.getElementById("deletelist").value += myDiv.getAttribute("textid") + ' ';
        myDiv = document.getElementById('cm'.concat(divid));
        myDiv.style.display = 'none'
    }
    else { 
        var myDiv = document.getElementById(divid);
        var displaySetting = myDiv.style.display;
        if (displaySetting == 'block') { 
          myDiv.style.display = 'none';
        } else { 
          myDiv.style.display = 'block';
        }
    }
}

function showall()
// show all text contents
{ 
    var comm = document.getElementsByClassName('textcontent');
    var ka;
    for (ka = 0; ka < comm.length; ka++) {
        comm[ka].style.display = 'block';
    }
}

function hideall()
// hide all text contents
{ 
    var comm = document.getElementsByClassName('textcontent');
    var ka;
    for (ka = 0; ka < comm.length; ka++) {
        comm[ka].style.display = 'none';
    }
}


function togglecomments() 
// toggles display of comments
{ 
//    console.log('toggle call '+divid )
    var btn = document.getElementById('commenttoggle');
    if (btn.value.indexOf('Show') >= 0) {  
        btn.value = 'Hide comments';
        var disp = 'block';    
    } else { 
        btn.value = 'Show comments';
        var disp = 'none';
    }
    var comm = document.getElementsByClassName('textcomm');
    var ka;
    for (ka = 0; ka < comm.length; ka++) {
        comm[ka].style.display = disp;
    }
}
</script>


{% autoescape off %}
    {{ document_header }}
{% endautoescape %}

<div style="padding: 5px;">
<input class = 'docbutton' id="commenttoggle" type="button" onclick="togglecomments()" value = "Show comments"/>
<input class = 'docbutton' type="button" onclick="showall()" value = "Show all content"/>
<input class = 'docbutton' type="button" onclick="hideall()" value = "Hide all content"/>
</div>
<div id="inputText" class="civ-text-display civ-text-display-size">
{% autoescape off %}
	{{markedtext}}
{% endautoescape %}
</div>

<form action="djciv_data/save_and_return" method = "post">{% csrf_token %}
    <div class="civ-form civ-form-size">
    {% autoescape off %}
        {{form_content}}
    {% endautoescape %}
    </div>
    {#<div style="float:right; "> #}
    {% if show_prev or show_next %}
         {% if show_prev %}
            <button type="submit" class = "pagebutton" formaction="prev_coder_page" style="float:left;">Prev</button>
        {% else %}
            <button type="submit" class = "pagebutton" formaction="prev_coder_page" style="visibility: hidden;">Prev</button>
        {% endif %}
        {% if show_next %}
            <button type="submit" class = "pagebutton" formaction="next_coder_page" style="float:right;">Next</button>
        {% else %}
            <button type="submit" class = "pagebutton" formaction="next_coder_page" style="  visibility: hidden;">Next</button>
        {% endif %}
    {% endif %}
    {#</div>#}

<div id="submitArea" style="clear:both; float:bottom; height:20px;padding:10px;border:2px dotted green;" >
<b>Options after saving:</b>
<button type="submit">Continue coding this collection</button>
<button type="submit" formaction="djciv_data/save_and_next">Code next collection</button>
<button type="submit" formaction="djciv_data/save_and_new">Select new collection</button>
<button type="submit" formaction="djciv_data/setup_workspace_download/coding">Download workspace and return to home page</button>
</div>
<input type="hidden" id="deletelist" name="deletelist">
</form>
</body>
</html>
